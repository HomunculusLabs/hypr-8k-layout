#!/bin/bash
# centerstage - Unified CLI for center-stage window management
#
# Usage: centerstage <command> [args]

SCRIPT_DIR="$HOME/.config/hypr/scripts"

show_help() {
    cat << 'EOF'
centerstage - Window management CLI for ultrawide displays

USAGE:
    centerstage <command> [args]

COMMANDS:
    restart              Restart the centerstage handler
    status               Show current layout state

    move <zone>          Move active window to zone
                         Zones: left, center, right, left-primary, left-secondary,
                                right-primary, right-secondary

    focus <pos>          Focus window by position
                         Positions: 0 = center, 1-9 = right sidebar
    swap <dir>           Swap or move windows
                         Directions: up, down, left, right
    swap-primary         Swap left-primary with center

    resize               Cycle center window width
    sidebar              Cycle sidebar balance
    height               Cycle center window height

    layout               Cycle left sidebar layout
    ratio <inc|dec>      Adjust left column ratio (increase/decrease)
    gap <inc|dec>        Adjust obsidian gap (increase/decrease)

    pbp                  Toggle picture-by-picture mode
    pip [corner] [size]  Avoid PIP overlay (tr/tl/br/bl, small/medium/large)
    shrink               Toggle auto-shrink mode

    retile [zone]        Retile zone(s) - left, right, center, or all
    save                 Save current layout
    restore              Restore saved layout

    help                 Show this help

EXAMPLES:
    centerstage move center
    centerstage resize
    centerstage layout
    centerstage gap increase
    centerstage pip tr small
EOF
}

show_status() {
    local state_dir="$HOME/.config/hypr/state"
    local workspace=$(hyprctl activeworkspace -j | jq -r .id)

    echo "=== Centerstage Status ==="
    echo "Workspace: $workspace"
    echo ""

    # Handler status
    if pgrep -f centerstage-handler > /dev/null; then
        echo "Handler: running"
    else
        echo "Handler: STOPPED"
    fi
    echo ""

    # Layout state
    echo "Layout:"
    echo "  Center width: $(cat "$state_dir/centerstage-center-width" 2>/dev/null || echo "default")"
    echo "  Left width:   $(cat "$state_dir/centerstage-left-width" 2>/dev/null || echo "default")"
    echo "  Right width:  $(cat "$state_dir/centerstage-right-width" 2>/dev/null || echo "default")"
    echo "  Left layout:  $(cat "$state_dir/centerstage-left-layout" 2>/dev/null || echo "single")"
    echo "  Shrink mode:  $(cat "$state_dir/centerstage-shrink-mode" 2>/dev/null || echo "off")"
    echo "  PBP mode:     $(cat "$state_dir/centerstage-pbp-mode" 2>/dev/null || echo "off")"
    echo ""

    # Window counts
    echo "Windows on workspace $workspace:"
    for zone in center left right left-primary left-secondary; do
        count=$(hyprctl clients -j | jq -r \
            "[.[] | select(.workspace.id == $workspace and .tags != null and (.tags | index(\"centerstage-$zone\")) != null)] | length")
        [[ "$count" -gt 0 ]] && echo "  $zone: $count"
    done
}

case "${1:-help}" in
    restart)
        "$SCRIPT_DIR/centerstage-restart.sh"
        ;;
    status)
        show_status
        ;;
    move)
        "$SCRIPT_DIR/centerstage-move.sh" "${2:-center}"
        ;;
    focus)
        focus_pos="${2:-0}"
        [[ "$focus_pos" == "center" ]] && focus_pos="0"
        "$SCRIPT_DIR/centerstage-focus.sh" "$focus_pos"
        ;;
    swap)
        "$SCRIPT_DIR/centerstage-swap.sh" "$2"
        ;;
    swap-primary)
        "$SCRIPT_DIR/centerstage-swap-primary-center.sh"
        ;;
    resize)
        "$SCRIPT_DIR/centerstage-resize.sh"
        ;;
    sidebar)
        "$SCRIPT_DIR/centerstage-sidebar.sh"
        ;;
    height)
        "$SCRIPT_DIR/centerstage-height.sh"
        ;;
    layout)
        "$SCRIPT_DIR/centerstage-left-layout.sh"
        ;;
    ratio)
        ratio_dir="${2:-}"
        case "$ratio_dir" in
            +) ratio_dir="increase" ;;
            -) ratio_dir="decrease" ;;
        esac
        "$SCRIPT_DIR/centerstage-left-ratio.sh" "$ratio_dir"
        ;;
    gap)
        gap_dir="${2:-}"
        case "$gap_dir" in
            +) gap_dir="increase" ;;
            -) gap_dir="decrease" ;;
        esac
        "$SCRIPT_DIR/centerstage-obsidian-gap.sh" "$gap_dir"
        ;;
    pbp)
        "$SCRIPT_DIR/centerstage-pbp-toggle.sh"
        ;;
    pip)
        corner="${2:-tr}"
        size="${3:-small}"
        "$SCRIPT_DIR/centerstage-pip.sh" "$corner" "$size"
        ;;
    shrink)
        "$SCRIPT_DIR/centerstage-shrink-toggle.sh"
        ;;
    retile)
        zone="${2:-all}"
        workspace=$(hyprctl activeworkspace -j | jq -r .id)
        if [[ "$zone" == "all" ]]; then
            "$SCRIPT_DIR/centerstage-retile.sh" left "$workspace"
            "$SCRIPT_DIR/centerstage-retile.sh" right "$workspace"
            "$SCRIPT_DIR/centerstage-retile.sh" center "$workspace"
        else
            "$SCRIPT_DIR/centerstage-retile.sh" "$zone" "$workspace"
        fi
        ;;
    save)
        "$SCRIPT_DIR/centerstage-save.sh"
        ;;
    restore)
        "$SCRIPT_DIR/centerstage-restore.sh"
        ;;
    startup)
        "$SCRIPT_DIR/centerstage-startup.sh"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'centerstage help' for usage"
        exit 1
        ;;
esac
